---
title: 2024å¼€æ‚Ÿæ™ºèƒ½ä½“æ¯”èµ›ï¼ˆæµ·é€‰èµ›ï¼‰
hide: false
math: true
abbrlink: 33143
date: 2024-09-03 11:36:19
index\_img:
banner\_img:
category:
  - coding
  - æ¯”èµ›
tags:
---

**å·²ç»“æŸçš„å…¨éƒ¨æ¯”èµ›ä»£ç **ï¼š[GitHub - æµ·é€‰èµ›å…¨éƒ¨ä»£ç ](https://github.com/wty-yy/kaiwu2024_taichu/tree/master/secret_realm/code)ï¼Œ[GitHub - å­¦ä¹ æœŸå…¨éƒ¨ä»£ç ](https://github.com/wty-yy/kaiwu2024_taichu/tree/master/gorgewalk/code)

ä¸‹æ–‡ä¸»è¦ä»‹ç»äº†æœ¬æ¬¡æ¯”èµ›å¯¹æºç çš„å­¦ä¹ ï¼Œç”±äºæ˜¯ç¬¬ä¸€æ¬¡å‚èµ›ï¼Œå¯¹æ•´ä¸ªæ¡†æ¶æ¯”è¾ƒé™Œç”Ÿï¼Œæ‰€ä»¥ç®€å•ä»‹ç»ä¸‹æˆ‘é€šè¿‡å­¦ä¹ æºç å¯¹åˆ†å¸ƒå¼æ¡†æ¶é€»è¾‘çš„ç†è§£ï¼Œä»¥åŠå¦‚ä½•åœ¨æ­¤åŸºç¡€ä¸Šå®Œæˆä¸€ä¸ªPPOç®—æ³•ã€‚

## é‡è¿”ç§˜å¢ƒ
> è¯¥æ¯”èµ›æ’åç¬¬6ï¼ˆ1380.17åˆ†ï¼Œå°½ç®¡åœ¨è‡ªå·±æµ‹è¯•300å±€ä¸­å¹³å‡å¾—åˆ†ä¸º1383åˆ†ï¼‰ï¼Œç¬¬ä¸€å1381.83åˆ†ï¼Œå¤±è´¥çš„ä¸»è¦åŸå› æ˜¯30æ¬¡è¯„æµ‹ä¸­ï¼ˆæ€»å…±9ä¸ªéšæœºå®ç®±ï¼‰ï¼Œå…¶ä¸­æœ‰ä¸€æ¬¡è¯„æµ‹ä¸­åªæ¡äº†8ä¸ªï¼Œå¦åˆ™å¯ä»¥è¶…è¿‡ç¬¬ä¸€å1åˆ†ä»¥ä¸Šï¼Œåªèƒ½è¯´æ™ºèƒ½ä½“è¿˜æ˜¯ä¸å¤Ÿç¨³å®šï¼Œæµ‹è¯•æ–¹æ³•ä¸å¤Ÿå¥½ï¼ˆæ€»å…±ä¹Ÿå°±715ç§å®ç®±åˆ†å¸ƒæƒ…å†µï¼Œæ²¡æœ‰å…¨éƒ¨è€ƒè™‘åˆ°ï¼‰ï¼Œå¥–åŠ±è®¾è®¡è¿˜æ˜¯é—®é¢˜ï¼Œå®ç®±é—æ¼çš„è´Ÿæƒ©ç½šä»ç„¶ä¸å¤Ÿå¤§ã€‚

PPOç®—æ³•å¯ä»¥åœ¨ä¸Šè¿°æºç ä¸­[diyæ–‡ä»¶å¤¹](https://github.com/wty-yy/kaiwu2024_taichu/tree/master/secret_realm/code/diy)ä¸‹æ‰¾åˆ°ï¼Œv1.2çš„è®­ç»ƒæ€»æ—¶é•¿ä¸º33+20+31.5+12.5=97å°æ—¶ï¼ˆ8~12è¿›ç¨‹ï¼‰æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè®­ç»ƒ12.5å°æ—¶å·²ç»èƒ½è¾¾åˆ°1350åˆ†äº†ã€‚

![æµ·é€‰èµ›æœ€ç»ˆæˆç»©](/figures/competitions/kaiwu/result4.png)
![è‡ªæµ‹v1.2.2éƒ¨åˆ†ç»“æœï¼ˆæ²¡ç”¨1.2.2å› ä¸ºå‡ºç°äº†5æ¬¡æµ‹è¯•ä¸­å‡ºç°äº†ä¸€æ¬¡1381çš„å‡åˆ†ï¼‰](/figures/competitions/kaiwu/result1.png)
![è‡ªæµ‹v1.2éƒ¨åˆ†ç»“æœï¼ˆ5æ¬¡æµ‹è¯•å‡åœ¨1382å’Œ1383ï¼‰](/figures/competitions/kaiwu/result3.png)
![æ¯”èµ›éƒ¨åˆ†å¯¹å±€ç»“æœ](/figures/competitions/kaiwu/result2.png)
![æœ€ç»ˆæ¯”èµ›æ—¶å‡ºç°çš„é”™è¯¯å¯»è·¯ç»“æœ](/figures/competitions/kaiwu/bad1.png)

ä»£ç åŸºç¡€æ¡†æ¶å’Œå­¦ä¹ æœŸç›¸åŒï¼Œæœ¬æ¬¡éš¾ç‚¹åœ¨äºåˆ†å¸ƒå¼æ¡†æ¶çš„ä½¿ç”¨ï¼Œç”±äºæˆ‘ä¸å–œæ¬¢ç”¨DQNï¼Œåªèƒ½å°è¯•å†™PPO

### å‰ç½®èŠå£«
ä¸‹æ–‡ä¸­æ‰€æœ‰çš„é…ç½®å‚æ•°ï¼Œè‹¥æ— ç‰¹æ®Šè¯´æ˜ï¼Œé»˜è®¤åœ¨ `conf/configure_app.toml` ä¸­ï¼Œå¦‚æœæ²¡æœ‰å¯¹åº”å˜é‡åï¼Œåˆ™éœ€è¦è‡ªå·±åŠ å…¥ï¼ˆtomlè¯­æ³•å¯ä»¥[å‚è€ƒå®˜ç½‘](https://toml.io/cn)ï¼Œå¯ä»¥åœ¨vscodeä¸­å®‰è£…tomlæ’ä»¶è¿›è¡Œæ¸²æŸ“ï¼‰

è¿™é‡Œçš„æ™ºèƒ½ä½“ä»£ç æˆ‘ä»¬éƒ½å·² `diy` ä¸­çš„ä¸ºä¾‹ï¼Œä»£ç ç»“æ„å¦‚ä¸‹ï¼ˆå¿…è¦éƒ¨åˆ†ï¼‰ï¼š
```bash
â””â”€â”€ code
 Â Â  â”œâ”€â”€ conf
 Â Â  â”‚Â Â  â”‚ # è‡ªå®šä¹‰çš„é…ç½®æ–‡ä»¶ï¼Œä¹Ÿæ˜¯æœ€é«˜ä¼˜å…ˆçº§ï¼Œå¯ä»¥è¦†ç›–ä»–ä»¬çš„é»˜è®¤é…ç½®
 Â Â  â”‚Â Â  â””â”€â”€ configure_app.toml
 Â Â  â””â”€â”€ diy
 Â Â   Â Â  â”œâ”€â”€ algorithm
 Â Â   Â Â  â”‚Â Â  â”‚ # æˆ‘ä»¬å®šä¹‰çš„æ™ºèƒ½ä½“Agentç±»ï¼Œå¿…é¡»æœ‰ä»–ä»¬è¦æ±‚çš„6ä¸ªå‡½æ•°
 Â Â   Â Â  â”‚Â Â  â”‚ # __init__, predict, exploit, learn, save_model, load_model
 Â Â   Â Â  â”‚Â Â  â””â”€â”€ agent.py
 Â Â   Â Â  â”œâ”€â”€ feature
 Â Â   Â Â  â”‚Â Â  â”‚ # å¯¹SampleData, ObsData, ActData,
 Â Â   Â Â  â”‚Â Â  â”‚ # observation_process, action_process, sample_process, 
 Â Â   Â Â  â”‚Â Â  â”‚ # SampleData2NumpyData, NumpyData2SampleDataè¿›è¡Œå®šä¹‰ï¼Œ
 Â Â   Â Â  â”‚Â Â  â”‚ # å®šä¹‰å¹¶è½¬æ¢å­˜å…¥bufferçš„æ•°æ®ç»“æ„
 Â Â   Â Â  â”‚Â Â  â””â”€â”€ definition.py
 Â Â   Â Â  â”‚ # é…ç½®æ–‡ä»¶ï¼Œ
 Â Â   Â Â  â”‚ # å¿…é¡»ä¿è¯Configç±»ä¸­çš„SAMPLE_DIM
 Â Â   Â Â  â”‚ # å’ŒNumpyData2SampleDataå‡½æ•°æ•°æ®å¯¹é½ï¼Œå¦åˆ™å¯èƒ½æŠ¥æ ·æœ¬ç»´åº¦é”™è¯¯
 Â Â   Â Â  â”œâ”€â”€ config.py
 Â Â   Â Â  â”‚ # æ¨¡å‹è®­ç»ƒæ—¶ä¼šè°ƒç”¨çš„è®­ç»ƒå·¥ä½œæµï¼Œç”¨äºæ ·æœ¬çš„é‡‡æ ·ä¸bufferå­˜å…¥
 Â Â   Â Â  â””â”€â”€ train_workflow.py
```

å®ç°äº†è¿™äº›å†…å®¹åï¼Œæœ‰ä¸¤ç§**å¯åŠ¨å•è¿›ç¨‹è®­ç»ƒ**çš„æ–¹æ³•ï¼ˆç”¨äºè°ƒè¯•ï¼‰ï¼š
1. å°† `train_test.py` ä¸­è®¾ç½®ä¸º `algorithm_name = "diy"` æ‰§è¡Œ `train_test.py` å°±å¯ä»¥è®­ç»ƒäº†ã€‚
2. å°† `configure_app.toml` ä¸­çš„å‚æ•°è®¾ç½®ä¸º `algo = "diy"`ï¼Œæ‰§è¡Œ `./tools/start.sh` å³å¯å¼€å§‹è®­ç»ƒã€‚

æ‰§è¡Œ `./tools/stop.sh all` å¯ä»¥æ€æ­»æ‰€æœ‰è¿›ç¨‹ã€‚

### local/remoteè®­ç»ƒé€»è¾‘

ä¸¤ç§è®­ç»ƒæ¨¡å¼local/remoteï¼Œè¿™å…³ç³»åˆ°è¿›ç¨‹çš„åˆ›å»ºæ•°ç›®ï¼ˆæµ·é€‰èµ›å’Œå­¦ä¹ æœŸçš„ä¸åŒä¹‹å¤„ï¼‰ï¼Œä¹Ÿæ­£å¦‚å®˜æ–¹æ‰€è¯´çš„ï¼Œç¡®å®å¯ä»¥åšåˆ°äº†ä¸¤ç§æ¨¡å¼ä¸‹ï¼Œä»£ç éƒ½å¯ä»¥ç›´æ¥è¿è¡Œï¼Œæœ€å¤§åŒºåˆ«åœ¨äºlocalä¸å­˜åœ¨bufferï¼Œè€Œremoteä¼šåˆ›å»ºä¸€ä¸ªbufferå­˜å‚¨aisrväº§ç”Ÿçš„æ ·æœ¬ã€‚

> ä¸‹é¢çš„é€»è¾‘åˆ†æéƒ½æ˜¯é€šè¿‡æŸ¥çœ‹æºç è·å¾—ï¼Œåˆ†ææ–¹æ³•ä¸»è¦æ˜¯åŸºäºPythonä¸­çš„tracebackå‡½æ•°ï¼Œè‡ªå·±å†™äº†ä¸€ä¸ªæ‰“å°å›è°ƒä¿¡æ¯çš„å‡½æ•° [`show_debug`](https://github.com/wty-yy/kaiwu2024/blob/master/secret_realm/code/diy/utils/__init__.py#L32)ï¼Œå¯¹æºç ä¸­çš„æ¯ä¸ªéƒ¨åˆ†åˆ†åˆ«åŠ å…¥è¯¥å‡½æ•°è¿›è¡Œè°ƒè¯•ã€‚é€»è¾‘åˆ†æçš„è¿‡ç¨‹è¯·è§[code_logic.md](https://github.com/wty-yy/kaiwu2024_taichu/blob/master/assets/code_logic.md#%E5%88%86%E5%B8%83%E5%BC%8F%E5%BC%80%E5%8F%91)ï¼Œé‡Œé¢æœ‰æ›´è¯¦ç»†çš„è°ƒç”¨å…³ç³»ï¼Œä»¥ä¸‹å†…å®¹ä¸ºç²¾ç®€ç‰ˆã€‚

ç”¨drawioç®€å•ç”»äº†ä¸ªç¤ºæ„å›¾ï¼ˆç”»çš„æŒºçƒ‚çš„ğŸ˜Ÿï¼‰ï¼Œå¯¹æ¯ä¸ªéƒ¨åˆ†çš„è¯¦ç»†ä»‹ç»è¯·è§ä¸‹æ–‡
![å¼€æ‚Ÿåˆ†å¸ƒå¼æ¶æ„ï¼ˆæç®€ç‰ˆï¼‰](/figures/competitions/kaiwu/kaiwu_workframe.png)

**local/remoteè®­ç»ƒæ¨¡å¼**ï¼šé…ç½®å‚æ•° `wrapper_type` å³å¯å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼Œæœ‰ä¸¤ä¸ªé…ç½®ï¼š
- `"local"`ï¼šä¹Ÿå°±æ˜¯å­¦ä¹ æœŸçš„æœ¬åœ°è®­ç»ƒï¼Œè¯¥æ¨¡å¼ä¸‹ï¼Œç³»ç»Ÿä¸ä¼šå¯¹ä½ çš„ `Agent` è¿›è¡ŒåŒ…è£…ï¼Œä»…åŒ…å«**ä¸€ä¸ªè®­ç»ƒè¿›ç¨‹aisrv**ï¼Œä¹Ÿå°±æ˜¯RLæœ€ç®€å•çš„è®­ç»ƒæ¨¡å¼ï¼Œåˆå§‹åŒ–ç¯å¢ƒã€æ™ºèƒ½ä½“ã€bufferï¼Œé€šè¿‡æ™ºèƒ½ä½“ä¸ç¯å¢ƒäº¤äº’è·å¾—æ ·æœ¬å­˜å‚¨åœ¨bufferä¸­ï¼Œè®­ç»ƒæ—¶ä»ä¸­è¿›è¡Œé‡‡æ ·ï¼Œæ›´æ–°valueå’Œpolicyç½‘ç»œã€‚
- `"remote"`ï¼šä¹Ÿå°±æ˜¯æµ·é€‰èµ›çš„å¤šè¿›ç¨‹è®­ç»ƒæ¨¡å¼ï¼Œè¯¥æ¨¡å¼ä¸‹ï¼Œç³»ç»Ÿä¼šåˆ›å»ºå¦‚ä¸‹å‡ ä¸ªè¿›ç¨‹ï¼š
    - learnerï¼š
        - åŠŸèƒ½ï¼šç”¨äºå¤„ç†bufferä¸­é‡‡æ ·çš„æ ·æœ¬ï¼Œæ›´æ–°valueå’Œpolicyç½‘ç»œï¼Œä¿å­˜ç½‘ç»œå‚æ•°ã€‚
        - ä»‹ç»ï¼šåŒ…å«ä¸€ä¸ªå®ä¾‹åŒ–çš„ `agent`ã€‚è¯¥è¿›ç¨‹åªä¼šè°ƒç”¨ `agent.learn` å‡½æ•°ï¼Œ**ä¸”è°ƒç”¨è¯¥å‡½æ•°ä¸å—æˆ‘ä»¬å†™çš„ä»£ç æ§åˆ¶**ï¼Œä»…æ ¹æ®é…ç½®ä¸­çš„bufferé€»è¾‘è¿›è¡Œåå°è¿›è¡Œè‡ªåŠ¨è°ƒç”¨ï¼Œå‚è€ƒä¸‹æ–‡ä¸­bufferçš„ä»‹ç»ã€‚
        - æ³¨æ„ï¼šåœ¨ `learn` ä¸­è°ƒç”¨ `save_model` å‡½æ•°åªä¼šå°†æ¨¡å‹ä¿å­˜åˆ°æœ¬æœºã€‚
    - actorï¼š
        - åŠŸèƒ½ï¼šåŸºäºçŠ¶æ€è¿›è¡Œæ¢ç´¢åŠ¨ä½œçš„é¢„æµ‹ï¼Œå¹¶ä¼šè‡ªåŠ¨ä» `model_pool` ä¸­æ›´æ–°æ¨¡å‹å‚æ•°ã€‚
        - ä»‹ç»ï¼šåŒ…å«ä¸€ä¸ªå®ä¾‹åŒ–çš„ `agent`ã€‚è¯¥è¿›ç¨‹åªä¼šè°ƒç”¨ `agent.predict, load_model`ï¼Œè¿™ä¸ªå‡½æ•°è¾“å…¥çš„çŠ¶æ€ä¿¡æ¯æ˜¯ç”± `aisrv` é€šè¿‡tcpå‘é€åˆ°è¯¥è¿›ç¨‹çš„ï¼ˆå¦‚æœæ¯ä¸ªç¯å¢ƒéƒ½å•å¼€ä¸€ä¸ªéå¸¸å®¹æ˜“å¯¼è‡´æ˜¾å­˜çˆ†ç‚¸ï¼Œå¹¶ä¸”åˆ†å¸ƒå¼ä¸‹ä¹Ÿä¸ä¸€å®šæ‰€æœ‰æœåŠ¡å™¨éƒ½æœ‰æ˜¾å¡ï¼‰ï¼Œå› æ­¤æ‰€æœ‰çš„ `aisrv` éƒ½å…±äº«çš„æ˜¯ä¸€ä¸ªç›¸åŒçš„ `agent` å®ä¾‹ï¼Œè¯¥ `agent` çš„æƒé‡æ›´æ–°ä¼šç”¨åˆ° `model_pool`ï¼Œæ­¤é€»è¾‘ä¼šåœ¨ä¸‹æ–‡è¿›è¡Œä»‹ç»ã€‚
    - aisrvï¼š
        - åŠŸèƒ½ï¼šä½¿ç”¨ `actor` ä¸­çš„ `agent` ä¸ä¸€ä¸ªç‹¬ç«‹çš„ç¯å¢ƒè¿›è¡Œäº¤äº’ï¼Œäº§ç”Ÿæ ·æœ¬ä¿å­˜åˆ°bufferä¸­ã€‚
        - ä»‹ç»ï¼šåŒ…å«ä¸€ä¸ªå®ä¾‹åŒ–çš„ç¯å¢ƒ `env`ï¼Œ**è¯¥è¿›ç¨‹ä¼šè°ƒç”¨ `train_workflow.workflow` å‡½æ•°**ã€‚æ³¨æ„ä¼ å…¥çš„ `agent` ä¸æ˜¯ä½ å†™çš„ `Agent` ç±»å®ä¾‹åŒ–ç»“æœï¼Œè€Œæ˜¯ `actor` çš„ï¼Œè°ƒç”¨æ‰€æœ‰ `predict, load_model` å‡½æ•°éƒ½ä¼šé€šè¿‡tcpå’Œ `actor` è¿›è¡Œé€šè®¯ï¼Œè€Œ `learn` å‡½æ•°åˆ™ä¸ä¼šèµ·åˆ°ä½œç”¨ï¼ˆç”±åå°æ ¹æ®é‡‡æ ·é€»è¾‘è¿›è¡Œé‡‡æ ·å¹¶å‘é€learnerè®­ç»ƒï¼‰ï¼Œå‘é€æ ·æœ¬åˆ°bufferçš„å‡½æ•°åˆ™æ˜¯ `learn`ã€‚
    - bufferï¼š
        - åŠŸèƒ½ï¼šå­˜å‚¨aisrvé€šè¿‡ `learn` å‘é€çš„æ ·æœ¬ï¼Œå¹¶åŸºäºé‡‡æ ·ç­–ç•¥è¿›è¡Œé‡‡æ ·ã€‚
        - ä»‹ç»ï¼šåŒ…å«ä¸€ä¸ªä» `reverb` åŒ…(Deepmind)ä¸­å®ä¾‹åŒ–çš„bufferã€‚å› æ­¤bufferçš„é‡‡æ ·å’Œç§»é™¤ç­–ç•¥å¯ä»¥[å‚è€ƒå®˜æ–¹æ–‡æ¡£](https://github.com/google-deepmind/reverb)ï¼Œå¸¸ç”¨çš„é‡‡æ ·ç­–ç•¥ä¸ºå‡åŒ€é‡‡æ · `Uniform`ï¼Œç§»é™¤ç­–ç•¥ä¸ºé¡ºåºç§»é™¤ï¼ˆå¯ä»¥æŠŠä»–æƒ³è±¡æˆä¸€ä¸ªé˜Ÿåˆ—ï¼ŒåŠ å…¥æ ·æœ¬å°±æ˜¯è¿›é˜Ÿå°¾ï¼Œé¡ºåºç§»é™¤å°±æ˜¯å¼¹å‡ºé˜Ÿé¦–ï¼‰ï¼Œè¿™ä¸ªé…ç½®ç›¸å…³å‚æ•°ä¸º `reverb_remover, reverb_sampler`ã€‚
    - model_poolï¼š
        - åŠŸèƒ½ï¼šè‡ªåŠ¨åŒæ­¥learnerä¿å­˜çš„æ¨¡å‹ï¼ˆä¿å­˜é¢‘ç‡ä¸ºé…ç½®ä¸­çš„ `dump_model_freq`ï¼ŒåŒæ­¥æ—¶é—´ä¸º `model_file_sync_per_minutes`ï¼Œå•ä½åˆ†é’Ÿï¼‰ï¼Œå¤„ç†actoræˆ–aisrvé€šè¿‡ `load_model` è¿›è¡Œè¯»å–æ¨¡å‹çš„è¯·æ±‚ã€‚
        - ä»‹ç»ï¼šåŒæ­¥learnerä¿å­˜çš„æ¨¡å‹ä»…èƒ½ä»æ¡†æ¶åŸºäº `dump_model_freq` è‡ªåŠ¨ä¿å­˜çš„ä½ç½®è¿›è¡Œè¯»å–ï¼ˆä¿å­˜åˆ°ä¸Šå›¾å³ä¸Šè§’frameworkå­˜å‚¨ä½ç½®ï¼‰ï¼Œä¹Ÿæ— æ³•æ‰‹åŠ¨è¿›è¡ŒåŒæ­¥ï¼Œåªèƒ½é€šè¿‡é…ç½®æŒ‡å®šçš„åŒæ­¥æ—¶é—´ `model_file_sync_per_minutes` è‡ªåŠ¨è¿›è¡ŒåŒæ­¥ï¼ˆç”±äºä»–è¿˜è¿›è¡Œäº†å–æ•´å¤„ç†ï¼Œå› æ­¤æœ€å°åŒæ­¥æ—¶é—´ä¸º1åˆ†é’Ÿï¼‰ã€‚
        - æ³¨æ„ï¼šmodel_poolå’Œä¿å­˜åœ¨æœ¬æœº `train/backup_model` çš„æ¨¡å‹ä¸åŒï¼Œmodel_poolæ˜¯å­˜å‚¨åˆ°å®¹å™¨ä¸­çš„ï¼Œè€Œåè€…æ˜¯å­˜å‚¨åœ¨æœ¬æœºçš„æŒ‚è½½ç›®å½•ä¸‹ï¼ˆä¹Ÿå°±æ˜¯å®¿ä¸»æœºï¼‰ã€‚

> åˆ†å¸ƒå¼çš„å¯åŠ¨æ–¹æ³•æˆ‘ä¼°è®¡æ˜¯å®¢æˆ·ç«¯å†™äº†docker composeé…ç½®æ–‡ä»¶ï¼Œé€šè¿‡composeåŠŸèƒ½åŒæ—¶å¼€äº†å¤šä¸ªå®¹å™¨ï¼ˆæ›´å¤šçš„envå’Œaisrvè¿›ç¨‹ï¼‰ä½¿ä»–ä»¬ä¹‹é—´ç”¨tcpé€šè®¯ï¼Œè¿˜æ²¡ç ”ç©¶è¿™å—å…·ä½“æ˜¯æ€ä¹ˆåšåˆ°çš„ã€‚ã€‚ã€‚

### PPOçš„å…·ä½“å®ç°ç»†èŠ‚
> åœ¨GitHubä¸­ä¹Ÿè®°å½•äº†å½“åˆ[å®ç°PPOæ³¨æ„çš„ç»†èŠ‚](https://github.com/wty-yy/kaiwu2024_taichu/tree/master/secret_realm/code#distribution-ppo)
> 
> è¿™é‡Œå¤§éƒ¨åˆ†æŠŠä¹‹å‰[è®ºå›](https://aiarena.tencent.com/community/d/505-you-mei-you-yong-ppode-lao-jiao-liu-yi-xia/28)å›å¤çš„å†…å®¹copyäº†ä¸€äº›ğŸ˜…

ä¸»è¦å°±æ˜¯æŠŠgaeæ”¾åˆ°learnerä¸­ç®—(å¾—åˆ°returnå’Œadv), bufferä¸­æ¯ä¸ªæ ·æœ¬å­˜çš„æ˜¯ä¸€æ®µè½¨è¿¹, è€Œlogprobä½¿ç”¨çš„æ˜¯actoré‡‡æ ·æ—¶å€™çš„å€¼, bufferçš„ä¿®æ”¹ï¼Œè¯·è§ [`definition.py`](https://github.com/wty-yy/kaiwu2024_taichu/blob/master/secret_realm/code/diy/feature/definition.py)ï¼š
```python
SampleData = create_cls("SampleData", obs=None, actions=None,
  rewards=None, dones=None, next_obs=None, next_done=None,
  logprobs=None)

@attached
def NumpyData2SampleData(data):  # bufferä¸­å–å‡ºæ¥ä»¥åè½¬æ¢
  n = args.num_steps  # æˆ‘è®¾çš„æ˜¯128, å°±æ˜¯å­˜å‚¨åˆ°bufferä¸­çš„ä¸€å°æ®µè½¨è¿¹é•¿åº¦
  obs_dim = args.obs_dim
  return SampleData(
    obs=data[:n*obs_dim].reshape(n, -1),
    actions=data[n*obs_dim:n*(obs_dim+1)],
    rewards=data[n*(obs_dim+1):n*(obs_dim+2)],
    dones=data[n*(obs_dim+2):n*(obs_dim+3)],
    logprobs=data[n*(obs_dim+3):n*(obs_dim+4)],
    next_obs=data[n*(obs_dim+4):-1],
    next_done=data[-1],
  )
```

[`configure_app.toml`](https://github.com/wty-yy/kaiwu2024_taichu/blob/master/secret_realm/code/conf/configure_app.toml) é…ç½®æ–‡ä»¶åšçš„ä¿®æ”¹å¦‚ä¸‹ï¼ˆå¤§æ¦‚ç‡ä¸æ˜¯æœ€ä¼˜çš„ï¼Œæ²¡æœ‰è¿›è¡Œå¾®è°ƒï¼‰ï¼š
```toml
# æ³¨: learner_train_by_while_true åœ¨9.2.2æœ€åä¸€æ¬¡æ›´æ–°åå°±åªèƒ½è®¾ç½®ä¸ºTrueæ‰èƒ½ä½¿ç”¨ï¼ˆä¸æ¸…æ¥šä¸ºä»€ä¹ˆï¼Œå•æœºæ¨¡å¼ä¸‹æ²¡æœ‰æµ‹å‡ºé—®é¢˜ï¼‰ï¼Œ
# ä¹Ÿå°±æ˜¯åªèƒ½å®šæ—¶è®­ç»ƒï¼Œé‚£ä¹ˆåªèƒ½è‡ªå·±æ‰‹åŠ¨è®¡ç®—ä¸€ä¸ªæ ·æœ¬äº§ç”Ÿæ‰€ç”¨çš„æ—¶é—´ï¼Œ
# å†è°ƒæ•´learner_train_sleep_secondsä¸º10ä¸ªæ ·æœ¬ç”Ÿæˆæ‰€éœ€çš„æ—¶é—´ï¼ˆéå¸¸éº»çƒ¦ï¼‰
learner_train_by_while_true = false  # å…³äº†è¿™ä¸ªproduction_consume_ratioæ‰æœ‰ç”¨
replay_buffer_capacity = 120  # process * 10
preload_ratio = 2  # å½“bufferä¸­å­˜åœ¨replay_buffer_capacity/preload_ratioä¸ªæ ·æœ¬æ—¶,å¼€å§‹è®­ç»ƒ,(ä¹Ÿè¦è¦æ±‚learner_train_by_while_true=False)
train_batch_size = 36  # learnerè®­ç»ƒæ‰¹å¤„ç†å¤§å°é™åˆ¶, process * 3
production_consume_ratio = 3  # æ¶ˆè€—/ç”Ÿæˆæ¯”
reverb_sampler = "reverb.selectors.Uniform"
dump_model_freq = 2  # PPOè¦æ±‚actorå’Œlearneræ¨¡å‹å·®è·ä¸èƒ½å¤ªå¤§, æé«˜åŒæ­¥æ¨¡å‹çš„ä¿å­˜é¢‘ç‡
model_file_sync_per_minutes = 1  # è¿™ä¸ªæ˜¯æ¨¡å‹åŒæ­¥åˆ°æ¨¡å‹æ± çš„åŒæ­¥æ—¶é—´ (å•ä½åˆ†é’Ÿ, æœ€å°1min)
```
æœ€åä¸ºäº†é¿å…å­˜å‚¨çš„æ¨¡å‹å¤ªå¤šå¯¼è‡´å†…å­˜çˆ†ç‚¸ï¼Œæˆ‘å†™äº†ä¸ªè‡ªåŠ¨åˆ é™¤æ—§æ¨¡å‹çš„å‡½æ•°ï¼Œåœ¨[learner](https://github.com/wty-yy/kaiwu2024_taichu/blob/0e620a6d17a92daeb77ed27a2a30cd25672f3e13/secret_realm/code/diy/algorithm/agent.py#L222)å’Œ[aisrv](https://github.com/wty-yy/kaiwu2024_taichu/blob/4714315cfd8202f38a38772e9e60f4d2b46ceb6b/secret_realm/code/diy/train_workflow.py#L87)ä¸­å‘¨æœŸæ€§è°ƒç”¨ã€‚
```python
from pathlib import Path
from kaiwudrl.common.config.config_control import CONFIG

def clean_ckpt_memory():
  """
  Remove old checkpoints generate by autosave (save frequency=CONFIG.dump_model_freq),
  you can find autosave code at
  `kaiwudrl.common.algorithms.standard_model_wrapper_pytorch.StandardModelWrapperPytorch.after_train()`

  Usage: Call this function in `agent.learn(...)` or `train_workflow.workflow`, 
  recommend in `agent.learn(...)` since it is a single process,
  add small delay as you like~~~
  """
  path_tmp_dir = Path(f"{CONFIG.restore_dir}/{CONFIG.app}_{CONFIG.algo}/")
  files = sorted(list(path_tmp_dir.glob('model.ckpt-*')), key=lambda x: int(str(x).rsplit('.', 1)[0].rsplit('-', 1)[1]))
  if len(files) < 2: return
  for p in files[:-1]:  # just keep latest checkpoint
    p.unlink()
```
è¯¦ç»†ä»£ç è¯·è§[diy/](https://github.com/wty-yy/kaiwu2024_taichu/tree/master/secret_realm/code/diy)æ–‡ä»¶å¤¹ï¼ŒPPOç®—æ³•å‚è€ƒçš„æ˜¯[cleanrl - PPO](https://docs.cleanrl.dev/rl-algorithms/ppo/)ã€‚

### Tensorboardä½¿ç”¨æ–¹æ³•
ç”±äºå®åœ¨ä¸ä¹ æƒ¯å®˜æ–¹ç»™çš„è®°å½•è½¯ä»¶ï¼Œè¿˜æ˜¯ç”¨äº†ä¼ ç»Ÿçš„Tensorboardï¼Œæ•ˆæœå›¾å¦‚ä¸‹
![Tensorboardæ•ˆæœå›¾ï¼ˆä¸Šé¢æ˜¯12ä¸ªç¯å¢ƒæ¯ä¸ªç¯å¢ƒç»“æŸæ—¶è®°å½•çš„ä¿¡æ¯ï¼Œä¸‹é¢ä¸ºlearnerè®­ç»ƒè®°å½•çš„ä¿¡æ¯ï¼‰](/figures/competitions/kaiwu/tb1.png)

åœ¨ `agent.py` é‡Œé¢å®ç°äº†ä¸€ä¸ªä¸‹é¢è¿™ä¸ªåˆå§‹åŒ– `writer` çš„[`init_writer` å‡½æ•°](https://github.com/wty-yy/kaiwu2024_taichu/blob/0e620a6d17a92daeb77ed27a2a30cd25672f3e13/secret_realm/code/diy/algorithm/agent.py#L28)

```python
import os, time
from pathlib import Path
from torch.utils.tensorboard import SummaryWriter

PATH_ROOT = Path(__file__).parents[2]
PATH_LOGS_DIR = PATH_ROOT / "log/tensorboard"
PATH_LOGS_DIR.mkdir(exist_ok=True, parents=True)

def init_writer(agent_type):
    # èµ·ä¸ªåå­—
    run_name = f"secret_realm_{agent_type}_pid{os.getpid()}_{time.strftime(r'%Y%m%d_%H%M%S')}"
    writer = SummaryWriter(str(PATH_LOGS_DIR / run_name))
    return writer
```
ç„¶ååˆ†åˆ«åœ¨learnerå’Œaisrvåˆå§‹åŒ–æ—¶å€™åˆ›å»ºå®ƒï¼Œlearnerä¹Ÿå°±æ˜¯åœ¨[åˆå§‹åŒ– `Agent`](https://github.com/wty-yy/kaiwu2024_taichu/blob/0e620a6d17a92daeb77ed27a2a30cd25672f3e13/secret_realm/code/diy/algorithm/agent.py#L46)æ—¶å€™ï¼Œaisrvä¹Ÿå°±æ˜¯åœ¨[åˆšè¿›å…¥`train_workflow.py`æ—¶å€™](https://github.com/wty-yy/kaiwu2024_taichu/blob/0e620a6d17a92daeb77ed27a2a30cd25672f3e13/secret_realm/code/diy/train_workflow.py#L22)ï¼ˆè¿™é‡Œä¸è¦åœ¨Agentä¸­åˆå§‹åŒ–åŸå› æ˜¯, æ‰€æœ‰çš„aisrvå…¶å®å…¬ç”¨çš„åŒä¸€ä¸ªAgentå®ä¾‹åŒ–ç»“æœ, æ‰€ä»¥ä»–åªä¼šè¢«åˆ›å»ºä¸€æ¬¡ï¼‰

ç„¶åå°±å’Œæ­£å¸¸ä½¿ç”¨tensorboardä¸€æ ·è®°å½•å°±å¥½äº†, æ¯”å¦‚åœ¨[ç¯å¢ƒç»“æŸ](https://github.com/wty-yy/kaiwu2024_taichu/blob/0e620a6d17a92daeb77ed27a2a30cd25672f3e13/secret_realm/code/diy/train_workflow.py#L49)æ—¶ï¼š
```python
if env.done:
  logger.info(f"pid={os.getpid()} End episode: gloabl_step={global_step}, episodic_reward={env.total_reward:.2f}, " +
           f"episodic_score={int(env.total_score)}, " +
           f"miss_treasure={env.miss_treasure}, n_treasure={env.n_treasure}")
  writer.add_scalar("charts/episodic_reward", env.total_reward, global_step)
  writer.add_scalar("charts/episodic_score", env.total_score, global_step)
  writer.add_scalar("charts/episodic_length", env.n_step, global_step)
  writer.add_scalar("charts/hit_wall", env.total_hit_wall, global_step)
  writer.add_scalar("charts/miss_treasure", env.miss_treasure, global_step)
  writer.add_scalar("charts/n_treasure", env.n_treasure, global_step)
  writer.add_scalar("charts/total_flash", env.total_flash, global_step)
  writer.add_scalar("charts/miss_buffer", env.miss_buffer, global_step)
```

**å¯åŠ¨æ–¹æ³•**ï¼š
- å¦‚æœæ˜¯ä»å®¢æˆ·ç«¯å¯åŠ¨è®­ç»ƒï¼Œç›´æ¥é€šè¿‡ `tensorboard --logdir [ä½ çš„å·¥ä½œè·¯å¾„]\train\log\tensorboard` å°±å¯ä»¥å®æ—¶çœ‹è®­ç»ƒæ›²çº¿äº†ã€‚
- å¦‚æœæ˜¯ä»ç›´æ¥è¿è¡Œçš„ `train_test.py` é‚£å°±ç›´æ¥åœ¨ `[ä½ çš„å·¥ä½œè·¯å¾„]\code\log\tensorboard` ä¸‹æ‰“å¼€å°±è¡Œäº†.

### ç½‘ç»œç»“æ„ä¸ç‰¹å¾è®¾è®¡
> ç”±äºæ²¡æœ‰ä½¿ç”¨å®˜æ–¹ç»™çš„dqnï¼Œè¿™éƒ¨åˆ†ä¹Ÿé¡ºä¾¿å…¨éƒ¨é‡å†™äº†ã€‚

æˆ‘ä»¬è®¾è®¡çš„ç½‘ç»œæä¸ºç®€å•ï¼šçº¯CNN+æ‹¼æ¥+MLPï¼ˆä¸èƒ½åœ¨ç®€å•äº†å§ğŸ˜‚ï¼‰ï¼Œä»£ç ä¸º[model.py](https://github.com/wty-yy/kaiwu2024_taichu/blob/master/secret_realm/code/diy/algorithm/model.py)
```python
class Backbone(nn.Module):
  def __init__(self):
    super().__init__()
    self.cnn = nn.Sequential(
      nn.Conv2d(4, 32, kernel_size=7, stride=2),
      nn.ReLU(),
      nn.Conv2d(32, 64, kernel_size=5, stride=2),
      nn.ReLU(),
      nn.Conv2d(64, 64, kernel_size=3, stride=1),
      nn.ReLU(),
      nn.Flatten(),
      nn.Linear(4096, 512),
      nn.ReLU()
    )
    self.fc = nn.Sequential(
      nn.Linear(512+args.observation_vec_shape[0], 512),
      nn.ReLU()
    )
    self.apply(layer_init)

  def forward(self, x):
    obs_size = np.prod(args.observation_img_shape)
    B = x.shape[0]
    img, vec = x[:, :obs_size], x[:, obs_size:]
    img = img.view(B, *args.observation_img_shape)
    x = torch.cat([self.cnn(img), vec], -1)
    return self.fc(x)
```
è¾“å…¥çš„ç‰¹å¾å¤„ç†å‡½æ•°ä¸º[definition.observation_process](https://github.com/wty-yy/kaiwu2024_taichu/blob/0e620a6d17a92daeb77ed27a2a30cd25672f3e13/secret_realm/code/diy/feature/definition.py#L286)ï¼š
```python
feature = np.hstack([
  np.stack([  # å›¾åƒç‰¹å¾: (4, 51, 51)
    obs['obstacle_map'],
    obs['memory_map'],
    obs['treasure_map'],
    obs['end_map'],
  ], axis=0).reshape(-1),
  # çº¿æ€§ç‰¹å¾: (31,)
  *obs['norm_pos'],
  *obs['treasure_flags'],
  *obs['treasure_grid_distance'],
  obs['buff_flag'],
  obs['buff_pos']['grid_distance'],
  obs['end_pos']['grid_distance'],
  # é—ªç°æ˜¯å¦å¯ç”¨: (1,)
  # è¿™ä¸ªmaskä¸æ˜¯æ¨¡å‹çš„è¾“å…¥ï¼Œåªæ˜¯ä¸€åŒå­˜å‚¨åˆ°obsä¸­ï¼Œéœ€è¦æ‰‹åŠ¨åˆ†ç¦»å‡ºæ¥
  obs['legal_act'][1],
]).astype(np.float32)
```

### å¥–åŠ±å‡½æ•°è®¾è®¡
è¿™ä¸ªå¥–åŠ±å‡½æ•°æˆ‘ä»¬å¤§éƒ¨åˆ†æ˜¯ç›´æ¥æ²¿ç”¨äº†å­¦ä¹ æœŸçš„è®¾è®¡ï¼Œä»[`definition.py`](https://github.com/wty-yy/kaiwu2024_taichu/blob/0e620a6d17a92daeb77ed27a2a30cd25672f3e13/secret_realm/code/diy/feature/definition.py#L116)ä¸­å°±èƒ½çœ‹åˆ°æˆ‘ä»¬è®¾è®¡çš„å¥–åŠ±å‡½æ•°ï¼Œç›¸åº”çš„é…ç½®æ–‡ä»¶ä½äº[config.pyçš„Args](https://github.com/wty-yy/kaiwu2024_taichu/blob/master/secret_realm/code/diy/config.py)ä¸­ï¼š
```python
r = 0
# 1. é‡å¤æ­¥éª¤æƒ©ç½šï¼Œå½“ä¸€ä¸ªä½ç½®é‡å¤èµ°è¿‡2æ¬¡ä»¥ä¸Š
ratio = self.total_timestep * args.num_envs / args.total_timesteps
if ratio < 0.5:  # å‰ä¸€åŠçš„æ—¶å€™è€ƒè™‘å½“å‰ä½ç½®çš„æƒ©ç½š
  r -= max(obs['memory_map'][25,25] - args.repeat_step_thre, 0)
  # assert obs['memory_map'][25,25] > 0  # won't be > 0
else:  # åä¸€åŠçš„æ—¶å€™è€ƒè™‘å‘¨å›´5x5ä½ç½®çš„åŠ æƒæƒ©ç½š
  r -= (args.repeat_punish * np.maximum(
    obs['memory_map'][23:28,23:28]-args.repeat_step_thre, 0)).sum()
# 2. åˆ°ç›®æ ‡ç‚¹ï¼ˆè¿™æ˜¯è®¾è®¡çš„æœ€å¤§é—®é¢˜ï¼Œå­¦ä¹ åˆ«äººçš„å¥–åŠ±å‡½æ•°æ—¶ï¼Œå‘ç°å¯ä»¥å½“å®ç®±æ²¡æœ‰æ”¶é›†å®Œæ—¶ä¸ç»™è¿™ä¸ªå¥–åŠ±ï¼‰
# ï¼ˆè¿™æ ·ç›´æ¥è®¾è®¡å¥–åŠ±ï¼Œå¯èƒ½è®©æ¨¡å‹ä¸¢å¤±éƒ¨åˆ†å®ç®±ï¼‰
if terminated:
  r += 150
  # å¯¹æœªæ¡åˆ°çš„å®ç®±åšåŠ æƒæƒ©ç½šï¼ŒåŠ æƒç³»æ•°ä¸å†å²ä¸­æœªæ¡åˆ°è¯¥å®ç®±æ¬¡æ•°æˆæ­£æ¯”
  r -= (obs['treasure_flags'] * self.treasure_reward_coef).sum() * 100
  # å¯¹æœªæ¡åˆ°çš„buffè¿›è¡Œæƒ©ç½š
  r -= obs['buff_flag'] * args.forget_buff_punish
  self.treasure_miss_cnt += obs['treasure_flags'].astype(np.int32)
# ç§»åŠ¨ç³»æ•°è®¡ç®—ï¼Œå¦‚æœæ˜¯ä½¿ç”¨é—ªç°åˆ™ä¼šç”¨æ›´å¤§çš„ç³»æ•°
dist_reward_coef = args.flash_dist_reward_coef if self.use_flash else args.dist_reward_coef
# åˆ°è¾¾ç»ˆç‚¹çš„ç›¸å¯¹è·ç¦»
delta_end_distance = self._obs['end_pos']['grid_distance'] - obs['end_pos']['grid_distance']
r += delta_end_distance * dist_reward_coef
# 3. åˆ°å®ç®±
if not terminated and score == 100:  # è·å¾—å®ç®±çš„å¥–åŠ±
  r += 100 * (self.treasure_reward_coef * (self._obs['treasure_flags'] ^ obs['treasure_flags'])).sum()
if sum(self._obs['treasure_flags']):  # ä¸æœ€è¿‘çš„å®ç®±è·ç¦»
  dist_treasure = np.max((self._obs['treasure_grid_distance'] -
                          self.obs['treasure_grid_distance']
                        )[self._obs['treasure_flags']])
  r += dist_treasure * dist_reward_coef
# 4. æ’å¢™æƒ©ç½š
if hit_wall:
  r -= args.flash_hit_wall_punish if self.use_flash else args.walk_hit_wall_punish
# 5. buffå¥–åŠ±
if self._obs['buff_flag'] - obs['buff_flag'] == 1:
  r += args.get_buff_reward
# 6. æ¯æ­¥çš„æƒ©ç½šï¼Œå¦‚æœæ˜¯åˆæ¬¡è®­ç»ƒåˆ™ååŠç¨‹æ‰åŠ å…¥ï¼Œå¦‚æœæ˜¯æ¥ç€è®­ç»ƒåˆ™ä¸€ç›´å­˜åœ¨
if ratio > 0.5 or args.load_model_id is not None:
  r -= args.each_step_punish
# 7. å…¨å±€å¥–åŠ±åŠ æƒç³»æ•°ï¼ˆç”±äºå¥–åŠ±å¤ªå¤§ï¼Œå…¨éƒ¨ç¼©å°çš„0.1å€ï¼‰
r *= args.reward_global_coef
```

æˆ‘ä»¬çš„ç‰ˆæœ¬è¿­ä»£æ—¥å¿—ä¸»è¦ä¸º `v0.4.3 -> v1.0 -> v1.1 -> v1.2 -> v1.2.x`ï¼Œæœ€åæäº¤çš„æ˜¯v1.2ï¼Œæ—¥å¿—æ–‡ä»¶å¯ä»¥åœ¨[code/readme.md](https://github.com/wty-yy/kaiwu2024_taichu/tree/master/secret_realm/code#2024813)ä¸­æ‰¾åˆ°ã€‚

### é˜¶æ®µæ€»ç»“
è¿™æ¬¡æ”¾å¤ªå¤šæ³¨æ„åŠ›åœ¨ç†è§£åˆ†å¸ƒå¼æ¡†æ¶å’Œå®ç°PPOç®—æ³•ä¸Šäº†ï¼Œä¸­é—´PPOç®—æ³•å®ç°é‡åˆ°äº†å¾ˆå¤šbugï¼Œæœ€åä¹Ÿæ˜¯æ²¡æœ‰å¯¹å¥–åŠ±å†è¿›è¡Œå¾®è°ƒï¼Œæ²¡æœ‰åœ¨æ‰€æœ‰å®ç®±ä½ç½®ä¸Šå¯¹æ¨¡å‹è¿›è¡Œæµ‹è¯•ï¼Œæ‰å¯¼è‡´å‡ºç°æ¼æ‰å®ç®±çš„é—®é¢˜ï¼Œä¸‹æ¬¡è¦å°†æ³¨æ„åŠ›æ›´å¤šé›†ä¸­åœ¨**ç¯å¢ƒè°ƒè¯•ï¼Œç½‘ç»œè®¾è®¡ï¼Œå‚æ•°å¾®è°ƒï¼Œå¥–åŠ±è®¾è®¡**ä¸Šã€‚

è¿™æ¬¡å­¦ä¹ äº†å¼€æ‚Ÿçš„åˆ†å¸ƒå¼æ¡†æ¶åŸç†ä¹Ÿæ˜¯ä¸€å¤§æ”¶è·ï¼Œåé¢ä¼°è®¡æˆ‘è‡ªå·±ä¹Ÿå¯ä»¥ç…§æ ·å­è®¾è®¡ä¸€ä¸ªï¼Œç”¨äºä¹‹å‰æ¯•è®¾æœªå®Œæˆçš„çœŸæ­£å¼ºåŒ–å­¦ä¹ AIè®­ç»ƒï¼ˆå½“ç„¶ç°åœ¨ç¡¬ä»¶è¿˜æ˜¯ä¸å¤Ÿï¼‰ã€‚

