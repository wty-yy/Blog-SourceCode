---
title: YOLOv2,YOLOv3ç¬”è®°
hide: false
math: true
abbrlink: 50137
date: 2023-10-04 10:06:33
index\_img:
banner\_img:
category:
 - CVPR
tags:
---

> [YOLO9000: Better, Faster, Stronger(YOLOv2)](https://arxiv.org/pdf/1612.08242.pdf), [YOLOv3: An Incremental Improvement](https://arxiv.org/pdf/1804.02767.pdf)
> éå¸¸å¥½çš„è§†é¢‘è®²è§£ï¼š[YouTube - ML For Neerds - YOLO OBJECT DETECTION SERIES](https://www.youtube.com/watch?v=zgbPj4lSc58&list=PL1u-h-YIOL0sZJsku-vq7cUGbqDEeDK0a)
> å…¨éƒ¨ä»£ç ï¼Œè‡ªå·±ç”¨JAX+Flax+Optaxå®ç°ï¼Œä»…åœ¨æ•°æ®è¯»å…¥å¤„ä½¿ç”¨TensorFlowï¼Œä»é›¶å¼€å§‹å®ç°YOLOv3ï¼ŒåŒ…æ‹¬æ¨¡å‹é¢„è®­ç»ƒå’Œå…¨æ¨¡å‹è®­ç»ƒï¼š[GitHub - KataCV/yolov3](https://github.com/wty-yy/KataCV/blob/master/katacv/yolov3/)

## YOLOv2, YOLOv3

åœ¨YOLOv2çš„åŸºç¡€ä¸Šå¯¹YOLOv1è¿›è¡Œäº†éå¸¸å¤šç»†èŠ‚ä¸Šçš„æ”¹åŠ¨ï¼Œè€ŒYOLOv3åˆ™å¯¹ç½‘ç»œæ¶æ„è¿›ä¸€æ­¥æ”¹è¿›ï¼ˆGaussé‡‘å­—å¡”ï¼‰ï¼Œä»è€Œå¾—åˆ°æ€§èƒ½æå¼ºçš„YOLOv3ã€‚åŒæ—¶å®ƒçš„è¯†åˆ«é€Ÿåº¦æå¿«ï¼Œæˆ‘åœ¨JAXä¸Šè¿›è¡Œå¤ç°ï¼Œå¯¹è§†é¢‘æ–‡ä»¶è¿›è¡Œå¤„ç†è¿‡ç¨‹ä¸­å‘ç°ï¼Œæ¨¡å‹çš„è¯†åˆ«é€Ÿåº¦ç«Ÿç„¶æœ‰447fpsï¼Œæœ€ç»ˆå‰ªè¾‘é€Ÿåº¦ä¸º92fpsï¼ˆè¢«è§†é¢‘è¯»å–é€Ÿåº¦æ‰€é™åˆ¶ï¼‰ã€‚

å€¼å¾—ä¸€æçš„æ˜¯YOLOv3æ˜¯YOLOå‘æ˜è€…Joseph Redmonç›®å‰æ‰€å‘è¡¨çš„æœ€åä¸€ç¯‡è®ºæ–‡ï¼ˆ2018/04/08ï¼‰ï¼Œåœ¨è¿™ç¯‡è®ºæ–‡çš„æœ€åä¸€æ®µè®²è¿°äº†å…¶åŸå› åœ¨äºï¼šå½“å‰çš„ç›®æ ‡è¯†åˆ«æŠ€æœ¯è¢«å•†ä¸šåŒ–ç”¨äºæ•æ‰å®¢æˆ·çš„éšç§æ•°æ®ã€è¢«å†›æ–¹æŠ•å…¥æ­¦å™¨ä½¿ç”¨å½“ä¸­ã€‚è¿™ä½¿å¾—ä½œè€…æ”¾å¼ƒäº†å¯¹YOLOç³»åˆ—çš„è¿›ä¸€æ­¥æ”¹è¿›ï¼Œä¸è¿‡åç»­ä¹Ÿæœ‰å¾ˆå¤šç‰ˆæœ¬ï¼Œå½“å‰å·²æ›´æ–°åˆ°YOLOv8ï¼Œä¸è¿‡åªæœ‰YOLOv4æ˜¯å­¦æœ¯ç ”ç©¶ï¼Œåé¢æ‰€æœ‰çš„ç‰ˆæœ¬å‡å¸¦æœ‰å…¬å¸ç‰ˆæƒä»¥å•†ä¸šåŒ–ä½œä¸ºç›®çš„ï¼ˆä¾‹å¦‚YOLOv5æ˜¯ç¾å›¢åšçš„ï¼‰æ— æ³•ç›´æ¥ä½¿ç”¨ã€‚

å¹¶ä¸”ï¼Œé€šè¿‡å­¦ä¹ YOLOv4ï¼Œæœ¬è´¨ä¸Šå…¶å¯¹YOLOv3çš„æ ¸å¿ƒæ¡†æ¶æ²¡æœ‰ä»»ä½•æ›´æ”¹ï¼Œåªæ˜¯å¯¹å…¶è¿›è¡Œäº†å¤§é‡ç»†èŠ‚ä¸Šçš„å¾®è°ƒï¼ŒåŒæ—¶ä¿è¯é€Ÿåº¦ä¸é™çš„å‰æä¸‹ï¼Œä½¿å¾—mAPæå‡äº†10%å·¦å³ã€‚æ‰€ä»¥å¦‚æœæƒ³åšYOLOv4ï¼Œä¸€å®šå…ˆè¦ç ”ç©¶æ¸…æ¥šYOLOv2å’ŒYOLOv3ã€‚

ä¸‹é¢æˆ‘ä»¬é€æ­¥åˆ†æYOLOv2å’ŒYOLOv3ä¸­è¿›è¡Œçš„æ”¹è¿›ã€‚

### å®šä¹‰åŠæ€è·¯

è®¾ $S\in \mathbb{N}^+$ è¡¨ç¤ºå½“å‰ç½‘æ ¼åˆ’åˆ†å¤§å°(Split size)ï¼Œ$C$ ä¸ºé¢„æµ‹çš„æ€»ç±»åˆ«æ•°ï¼Œ$A_S$ ä¸ºç½‘æ ¼å¤§å°ä¸º $S$ æ—¶çš„é”šæ¡†(Anchor bounding box)é›†åˆã€‚

---

åœ¨YOLOv3ä¸­åŠ å…¥äº†**é”šæ¡†(Anchor bounding box)**è¿™æ ·çš„ä¸€ä¸ªæ¦‚å¿µï¼Œè¿™ä¸ªæ¦‚å¿µæ˜¯R-CNNä¸­ä½¿ç”¨åˆ°çš„ï¼Œä¹Ÿå°±æ˜¯å¯¹è¾¹ç•Œæ¡†çš„å¤§è‡´å½¢çŠ¶çš„ä¸€ä¸ªä¼°è®¡ï¼Œè¿™ä¸ªé”šæ¡†æ˜¯é€šè¿‡å¯¹å…¨ä½“è¾¹ç•Œæ¡†åšKè¿‘é‚»å¾—åˆ°çš„ï¼ˆä»¥è´Ÿçš„ç›¸å¯¹IOUä½œä¸ºè·ç¦»è¡¡é‡æ ‡å‡†ï¼‰ï¼Œæœ€åçš„æ¨¡å‹é¢„æµ‹ä¹Ÿè¦ä»ç›´æ¥å¯¹è¾¹ç•Œæ¡†çš„å®½é«˜è¿›è¡Œé¢„æµ‹ï¼Œè½¬ä¸ºå¯¹é”šæ¡†çš„å®½é«˜ç›¸å¯¹æ¯”ä¾‹è¿›è¡Œé¢„æµ‹ã€‚

åœ¨YOLOv3ä¸­ï¼Œä¼šåœ¨ $3$ ä¸ªä¸åŒè€Œ**ç¼©æ”¾å°ºåº¦(scale)**ä¸‹æ¯ä¸ª**ç½‘æ ¼(cell)**åˆ†åˆ«é¢„æµ‹å‡º $3$ ä¸ª**ç›¸å¯¹äºé”šæ¡†çš„è¾¹ç•Œæ¡†**ã€‚ä»¥ä¸‹å›¾ä¸ºä¾‹ï¼ˆå›¾ç‰‡ç”±è‡ªå·±å†™çš„æ•°æ®é›†é¢„å¤„ç†ä»£ç ç”Ÿæˆ[GitHub]ï¼‰ï¼š

![3ä¸ªä¸åŒç½‘æ ¼å¤§å°ä¸‹çš„æ ‡ç­¾ï¼Œçº¢è‰²ä¸ºçœŸå®çš„æ ‡ç­¾ï¼Œæ©™è‰²ä¸ºè®¾å®šå¥½çš„é”šæ¡†ï¼Œåœ¨3ä¸ªä¸åŒçš„ç½‘æ ¼å¤§å°ä¸‹æˆ‘ä»¬å„åˆ†é…äº†3ä¸ªé”šæ¡†](/figures/CVPR/YOLOv3/test_build_dataset.jpg)

è¿™é‡Œçš„ç½‘æ ¼åˆ’åˆ†çš„æ¦‚å¿µå’ŒYOLOv1ä¸€è‡´ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¼šå°†æ¯ä¸ªæ¡†æ­£ä¸­å¿ƒæ‰€å±çš„ç½‘æ ¼ä½œä¸ºå¯¹è¯¥æ¡†è¿›è¡Œé¢„æµ‹çš„ç½‘æ ¼ã€‚åœ¨YOLOv1ä¸­æˆ‘ä»¬æ¯ä¸ªç½‘æ ¼ä¸Šä¼šé¢„æµ‹2ä¸ªè¾¹ç•Œæ¡†ï¼Œè€ŒYOLOv3ä¸­æˆ‘ä»¬ä¼šé¢„æµ‹3ä¸ªè¾¹ç•Œæ¡†ï¼Œå¹¶ä¸”å®½é«˜æ˜¯ç›¸å¯¹äºåˆé€‚å¤§å°çš„é”šæ¡†çš„ï¼Œè§ä¸‹æ–‡ã€‚

æœ€å³ä¾§çš„æ˜¯åŸå›¾ä»¥åŠå…¶ä¸­çš„æ‰€æœ‰å¾…æ£€æµ‹çš„è¾¹ç•Œæ¡†ï¼Œå·¦è¾¹ä¸‰ä¸ªåˆ†åˆ«æ˜¯åœ¨3ä¸ªä¸åŒç½‘æ ¼å¤§å°ä¸‹çš„å’ŒçœŸå®æ¡†æœ€æ¥è¿‘çš„é”šæ¡†ï¼ˆè¿™é‡Œæˆ‘åªæ˜¾ç¤ºäº† $\text{IOU}>0.35$ï¼‰ï¼Œä»CVçš„çŸ¥è¯†å¯ä»¥çŸ¥é“ï¼Œå¯¹äº**åˆ†è¾¨ç‡è¶Šé«˜**çš„å›¾åƒç»†èŠ‚çš„ä¿¡æ¯è¶Šå¤šèƒ½æ˜“äºè¯†åˆ«**å°ç›®æ ‡**ï¼ˆå·¦è¾¹ç¬¬ä¸€ä¸ªï¼‰ï¼Œå¯¹äº**åˆ†è¾¨ç‡è¶Šä½**çš„å›¾åƒç»†èŠ‚ä¸¢å¤±è¶Šå¤šæ˜“äºè¯†åˆ«**å¤§ç›®æ ‡**ï¼ˆå·¦è¾¹ç¬¬ä¸‰ä¸ªï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬**å°†é”šæ¡†å¤§å°ä»å°åˆ°å¤§å¹³å‡åˆ†é…åˆ°åˆ†è¾¨ç‡ä»å¤§åˆ°å°çš„å›¾åƒæ£€æµ‹å½“ä¸­**ï¼Œæˆ‘ä»¬å¸Œæœ›æ¨¡å‹èƒ½åœ¨é«˜/ä½åˆ†è¾¨ç‡ä¸‹åˆ©ç”¨å°/å¤§é”šæ¡†æ£€æµ‹å‡ºä¸Šå›¾å·¦è¾¹ç¬¬ä¸€/ä¸‰ä¸ªå›¾ç‰‡ä¸­çš„æ‰€æœ‰ç›®æ ‡ã€‚

å‡è®¾æˆ‘ä»¬æœ‰ä¸‹è¿°9ä¸ªé”šæ¡†ï¼ˆè®ºæ–‡ä¸­æä¾›äº†å³ä¾§çš„åƒç´ å¤§å°ï¼Œåº”è¯¥æ˜¯æ ¹æ®COCOæ•°æ®é›†åœ¨$416\times 416$åˆ†è¾¨ç‡ä¸‹åš$K=9$è¿‘é‚»çš„å¾—åˆ°çš„ï¼Œä½†æ˜¯è¿™å…·æœ‰ä¸€èˆ¬æ€§ï¼Œæ‰€ä»¥æˆ‘åœ¨PASCALæ•°æ®é›†ä¸Šä¹Ÿç”¨çš„æ˜¯è¿™9ä¸ªé”šæ¡†ï¼‰ï¼š
```vim
anchors = [  # é”šæ¡†çš„å®½é«˜ç›¸å¯¹æ•´ä¸ªå›¾ç‰‡çš„å®½é«˜æ¯”ä¾‹
    (0.02, 0.03), (0.04, 0.07), (0.08, 0.06),  # (10, 13), (16, 30), (33, 23),  # in 416x416
    (0.07, 0.15), (0.15, 0.11), (0.14, 0.29),  # (30, 61), (62, 45), (59, 119),
    (0.28, 0.22), (0.38, 0.48), (0.90, 0.78),  # (116, 90), (156, 198), (373, 326)
]
```

å‡è®¾æˆ‘ä»¬ä¹Ÿæœ‰ $3$ ä¸ªä¸åŒçš„ç½‘æ ¼åˆ’åˆ†å¤§å° $S\in\{52,26,13\}$ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä¾ç…§åˆ†è¾¨ç‡ä¸é”šæ¡†å¤§å°æˆåæ¯”çš„å…³ç³»å¯¹é”šæ¡†è¿›è¡Œåˆ†é…ï¼š

$$
\begin{aligned}
A_{52} =&\ \{(0.02, 0.03), (0.04, 0.07), (0.08, 0.06)\}\\
A_{26} =&\ \{(0.07, 0.15), (0.15, 0.11), (0.14, 0.29)\}\\
A_{13} =&\ \{(0.28, 0.22), (0.38, 0.48), (0.90, 0.78)\}
\end{aligned}
$$

è¿™ä¹Ÿæ­£æ˜¯ä¸Šå›¾ä¸­æ¯ä¸ªç½‘æ ¼åˆ’åˆ†ä¸‹çš„é”šæ¡†å¤§å°ã€‚æˆ‘ä»¬æ¯”è¾ƒä¸‹YOLOv1å’ŒYOLOv3æ€»å…±ä¼šé¢„æµ‹çš„è¾¹ç•Œæ¡†æ•°ç›®ï¼š

$$
N_{\text{predict bbox}} = \begin{cases}
2\cdot 7^2 = 98,&\quad \text{YOLOv1},\\
3\cdot (52^2 + 26^2 + 13^2) = 10647,&\quad \text{YOLOv3}.
\end{cases}
$$

ç„¶è€Œå¦‚ä½•è®©æ¨¡å‹èƒ½å¤Ÿçœ‹åˆ°ä¸åŒåˆ†è¾¨ç‡ä¸‹çš„å›¾åƒå‘¢ï¼Ÿè¿™å°±éœ€è¦å¯¹ç½‘ç»œçš„è®¾è®¡äº†ï¼ˆä¸‹ä¸€éƒ¨åˆ†ä¼šè¯¦ç»†ä»‹ç»ï¼‰ã€‚

### ç½‘ç»œè®¾è®¡

ä¸‹å›¾æ˜¯ä¸€ä¸ªéå¸¸æ¸…æ™°çš„ç½‘ç»œæ¶æ„ï¼Œæ¥è‡ª [çŸ¥ä¹ - Algernon](https://zhuanlan.zhihu.com/p/76802514)ï¼š

![YOLOv3ç½‘ç»œæ¶æ„](/figures/CVPR/YOLOv3/yolov3-network.jpg)

> ä»£ç ï¼šè‡ªå·±å®ç°çš„[GitHub - (JAX)DarkNet-53 é¢„è®­ç»ƒ](https://github.com/wty-yy/KataCV/blob/master/katacv/yolov3/darknet53.py)å’Œ[GitHub - (JAX)YOLOv3-model å®Œæ•´æ¨¡å‹](https://github.com/wty-yy/KataCV/blob/master/katacv/yolov3/yolov3_model.py)ï¼Œä¹Ÿæœ‰åˆ«äººç”¨PyTorchå®ç°çš„[GitHub - (PyTorch)YOLOv3-model](https://github.com/aladdinpersson/Machine-Learning-Collection/blob/master/ML/Pytorch/object_detection/YOLOv3/model.py)

#### DarkNet-53

å·¦ä¸Šè§’è™šçº¿æ¡†å†…ä¸ºéª¨å¹²å±‚backboneä½œè€…ç§°ä¹‹ä¸º`DarkNet-53`ï¼ˆé»‘æš—éª‘å£«ğŸ¤£ï¼‰ï¼Œåœ¨Imagenetä¸Šè¿›è¡Œé¢„è®­ç»ƒæ‰€éœ€çš„å…¨éƒ¨å·ç§¯å±‚å’Œå…¨è¿æ¥å±‚æ€»å…± $53$ å±‚ï¼Œä½¿ç”¨çš„æ¿€æ´»å‡½æ•°å‡ä¸º `leaky_relu(k=0.1)`ï¼Œå…¨éƒ¨éè¾“å‡ºå¤„çš„å·ç§¯å—éƒ½ä¸º `Conv + BatchNormalize + leaky_relu(0.1)`ã€‚

> æ³¨æ„åœ¨æœ‰ `BN` å±‚çš„æ—¶å€™æ— éœ€å¯¹ `Conv` åŠ ä¸Šå¤šä½™çš„åç½®ï¼Œå› ä¸º `BN` ä¸­çš„åç½®èƒ½èµ·åˆ°ç›¸åŒä½œç”¨ï¼Œ[BNè®ºæ–‡ä¸­3.2æ®µ](https://arxiv.org/pdf/1502.03167.pdf)è¿›è¡Œäº†è§£é‡Šã€‚

è®­ç»ƒç»“æœå¯ä»¥ç›´æ¥æŸ¥çœ‹wandbåˆ†äº«çš„ç½‘é¡µ [ImageNet Result](https://api.wandb.ai/links/wty-yy/21lkb6fg)

![è¿™é‡Œæˆ‘ç”¨DarkNet-53åœ¨éªŒè¯é›†ä¸Šçš„ç»“æœå’ŒResNet-50ç»“æœç±»ä¼¼ï¼Œtop1=75%,top5=92%ï¼Œä½†æ˜¯DarkNet-53å‚æ•°æ•°é‡è¿˜ç•¥å¾®å¤§äº›ï¼Œæ¨æ–­é€Ÿåº¦è¿˜æœ‰å¾…æµ‹è¯•](/figures/CVPR/YOLOv3/ResNet50_and_DarkNet53.png)

#### Neck

Neckè¿™ä¸ªæ¦‚å¿µæ¥è‡ªYOLOv4ï¼Œä»–ä»¬å°†éª¨å¹²å±‚åç»­ç½‘ç»œæˆä¸ºNeckï¼Œè¡¨ç¤ºå¯¹ç‰¹å¾çš„è¿›ä¸€æ­¥èšåˆã€‚åœ¨ä¸Šå›¾ä¸­å°±æ˜¯é™¤äº†è™šçº¿æ¡†å¤–çš„æ‰€æœ‰éƒ¨åˆ†ï¼Œè¿™ä¸ªè¾“å‡ºæ­£å¥½æ„æˆGaussé‡‘å­—å¡”ï¼Œç”±è®ºæ–‡[Feature Pyramid Networks for Object Detection(FPN)](https://openaccess.thecvf.com/content_cvpr_2017/papers/Lin_Feature_Pyramid_Networks_CVPR_2017_paper.pdf)æå‡ºï¼Œå†å¯¹æ¯ä¸ªä¸åŒscaleä¸‹çš„ç»“æœåˆ†é…ä¸åŒçš„anchorsè¿›è¡Œé¢„æµ‹ï¼ˆåç»­å¯¹FPNè¿˜æœ‰è®¸å¤šæ”¹è¿›ï¼Œä¾‹å¦‚PAN, NAS-FPN...ï¼Œåœ¨YOLOv4ä¸­å°±æ˜¯ä½¿ç”¨äº†PANè¿›è¡Œç‰¹å¾èšåˆï¼‰

#### Outputs

ä¸Šå›¾ä¸­çš„è¾“å…¥å›¾åƒå¤§å°ä¸º $256\times 256\times 3$ï¼Œè¿™ä¸ªå¹¶ä¸æ˜¯è®ºæ–‡ä¸­è®¾è®¡çš„è¾“å…¥å¤§å°ï¼Œåœ¨YOLOv2è®ºæ–‡ä¸­è¦æ±‚ï¼Œæœ€åçš„ç‰¹å¾è¾“å‡ºå®½é«˜å¿…é¡»ä¸ºå¥‡æ•°ï¼ˆä¸ºäº†ä¿è¯ä½äºä¸­å¿ƒå¤„çš„è¾¹ç•Œæ¡†æœ‰ä»å±çš„ç½‘æ ¼ï¼‰ï¼Œæ‰€ä»¥ä»–è®¾è®¡çš„è¾“å‡ºä¸º $13\times 13$ï¼Œå›¾åƒçš„è¾“å…¥å¤§å°ä¸º $416\times 416$ï¼Œç»è¿‡ä¸Šå›¾ç½‘ç»œçš„è¾“å‡ºï¼Œä¸‰ä¸ªå°ºåº¦ä¸‹çš„ç‰¹å¾å¤§å°åº”è¯¥ä¸º $52\times 52, 26\times 26, 13\times 13$ã€‚

è¾“å‡ºçš„ç‰¹å¾ç»´åº¦ä¸º $255$ åŸå› åœ¨äºï¼š$B(5+C) = 255,\ (B=3,C=80)$ï¼Œ$B$ ä¸ºæ¯ä¸ªå°ºåº¦ä¸‹æ¯ä¸ªç½‘æ ¼éœ€è¦é¢„æµ‹çš„è¾¹ç•Œæ¡†æ•°ç›®ï¼ˆä¹Ÿæ˜¯æ‰€åˆ†é…çš„é”šæ¡†æ•°ç›®ï¼‰ï¼Œ$C$ ä¸ºä¸­ç›®æ ‡ç±»åˆ«æ•°ã€‚æˆ‘ä»¬å¯ä»¥å°†æœ€åä¸€ä¸ªç»´åº¦è¿›ä¸€æ­¥åˆ’åˆ†ä¸º $(B,5+C)$ï¼Œå…¶ä¸­å‰ $5$ ä¸ªå˜é‡è¡¨ç¤º $(c,x,y,w,h)$ å $C$ ä¸ªå˜é‡è¡¨ç¤ºå¯¹æ‰€å±ç±»åˆ«çš„æ¦‚ç‡åˆ†å¸ƒ $\{p_c\}$ã€‚ï¼ˆè¿›ä¸€æ­¥è§£é‡Šè¯·è§ä¸‹ä¸€éƒ¨åˆ†ï¼‰

### æ¨¡å‹é¢„æµ‹

ä»¥ $416\times 416\times 3$ çš„å›¾åƒè¾“å…¥ä¸ºä¾‹ï¼Œåˆ™ç½‘æ ¼åˆ’åˆ†å¤§å°åˆ†åˆ«ä¸º $S\in\{52,26,13\}$ï¼Œä¸‹é¢åˆ†åˆ«å¯¹æ¯ä¸ªå°ºåº¦å•ç‹¬è¿›è¡Œè®¨è®ºï¼Œç”±äºæ¯ä¸ªå°ºåº¦ä¸‹éƒ½åˆ†é…äº† $3$ ä¸ªé”šæ¡† $A_S$ï¼Œä¸” $S$ ä¸é”šæ¡†é¢ç§¯æˆåæ¯”ã€‚å¯¹äºæ¯ä¸ªè¾¹ç•Œæ¡†éœ€è¦åŒ…å« $6$ ä¸ªå‚æ•°ï¼š$(c,x,y,w,h)$ å’Œç±»åˆ«åˆ†å¸ƒ $\{p_c\}_{c=1}^C$ï¼Œå‡è®¾å½“å‰è¾¹ç•Œæ¡†å¯¹åº”é”šæ¡†çš„å®½å’Œé«˜åˆ†åˆ«ä¸º $(w_a, h_a)$ å…¶ä¸­

$$
\begin{cases}
c = \text{Pr}(\text{Object})\cdot \text{IOU}_{pred}^{true},\\
(x,y) = \text{è¾¹ç•Œæ¡†ä¸­å¿ƒåæ ‡ç›¸å¯¹äºå½“å‰ç½‘æ ¼çš„å·¦ä¸Šè§’},\\
(w,h) = \text{ç›¸å¯¹äºå½“å‰ç½‘æ ¼ä¸‹çš„é”šæ¡†çš„å®½é«˜æ¯”ä¾‹},\\
p_c = \text{Pr}(\text{Class} = c)
\end{cases}
$$

> tricksï¼šç”±äº $c,x,y\in(0,1), w,h\in(0,\infty), \{p_c\}_{c=1}^C$ï¼Œåˆ™å¯ä»¥å¯¹æ¨¡å‹çš„è¾“å‡ºåˆ†åˆ«åš $\text{sigmoid}(x)$ï¼Œ$\text{e}^x$ï¼Œ$\text{softmax}$ å˜æ¢ã€‚

### æ ‡ç­¾å¤„ç†

è¿™éƒ¨åˆ†å°†æ•°æ®é›†çš„è¾¹ç•Œæ¡†æ ‡ç­¾è½¬åŒ–ä¸ºYOLOv3æ‰€éœ€çš„æ ‡ç­¾ï¼Œå¯¹äºä¸€ä¸ªå›¾ç‰‡çš„å…¨éƒ¨çœŸå®è¾¹ç•Œæ¡†ï¼ˆç›®æ ‡æ¡†ï¼‰é›†åˆï¼Œæˆ‘ä»¬è®°ä¸º $T=\{b_i = (cls,x,y,w,h): i\in\{1,...,N\}\}$ï¼Œå…¶ä¸­ $cls\in\{1,...,C\}$ è¡¨ç¤ºè¾¹ç•Œæ¡†å¯¹è±¡çš„ç±»åˆ«ï¼Œ$(x,y)$ è¡¨ç¤ºè¾¹ç•Œæ¡†çš„ä¸­å¿ƒç‚¹ç›¸å¯¹äºæ•´ä¸ªå›¾åƒçš„æ¯”ä¾‹ï¼Œ$(w,h)$ è¡¨ç¤ºè¾¹ç•Œæ¡†çš„å®½é«˜ç›¸å¯¹äºæ•´ä¸ªå›¾åƒçš„æ¯”ä¾‹ã€‚

å¯¹äºä¸€ä¸ªç›®æ ‡æ¡† $b_t\in T$ï¼Œåœ¨ç½‘æ ¼åˆ’åˆ† $S$ ä¸‹ï¼Œå…¶ä¸­å¿ƒç‚¹ä½äºç¬¬ $(i,j),\ i,j \in \{0,...,S-1\}$ ä¸ªç½‘æ ¼å¤„ï¼Œæ˜“çŸ¥

$$
i = [xS],\quad j = [yS],\quad [\cdot]\text{è¡¨ç¤ºå–æ•´å‡½æ•°}
$$

è®¾é”šæ¡†é›†åˆæŒ‰ç…§IOUä»å¤§åˆ°å°æ’åºè®°ä¸º
$$
A_S = \bigg\{b_1,b_2,\cdots,b_{|A_S|}:\text{IOU}_{b_u}^{b_t} > \text{IOU}_{b_v}^{b_t}, \big(u < v\text{ä¸”} u,v\in\{1,\cdots,|A_S|\}\big) \bigg\}
$$
å¹¶ä¸”å°†æ’åºåé”šæ¡† $b_i$ å¯¹åº”äºåŸé”šæ¡†é›†åˆä¸­çš„ç¼–å·è®°ä¸º $a_i$ï¼Œç›®æ ‡çŠ¶æ€è®°ä¸º $y_S\in\R^{S\times S\times |A_S|\times 6}$ï¼Œå…¶ä¸­ $y_S(i,j,k)$ è¡¨ç¤ºå½“å‰ç½‘æ ¼åˆ’åˆ†ä¸‹ç¬¬ $(i,j)$ ä¸ªç½‘æ ¼ä¸Šçš„ç¬¬ $k$ ä¸ªé”šæ¡†å¯¹åº”çš„å…­å…ƒç»„ $(c,x,y,w,h,cls)$ï¼Œåˆ†åˆ«è¡¨ç¤º**ç½®ä¿¡åº¦ã€è¾¹ç•Œæ¡†ä¸­å¿ƒç›¸å¯¹ç½‘æ ¼è€Œåæ ‡ã€è¾¹ç•Œæ¡†ç›¸å¯¹ç½‘æ ¼çš„å®½é«˜æ¯”ä¾‹å’Œæ‰€å±çš„ç±»åˆ«**ï¼Œç»™å®šæ ·æœ¬å¿½ç•¥ç³»æ•° $\alpha_{ignore}\in(0,1)$ï¼Œåˆ™ $b_t$ å½“ä¸”ä»…æœ‰ä»¥ä¸‹ $3$ ä¸ªçŠ¶æ€ä¹‹ä¸€ï¼š

1. æ­£ä¾‹(positive)ï¼š$b_1$ ä¸€å®šä¸ºæ­£ä¾‹ï¼Œä»¤ç½®ä¿¡åº¦ $c_{i,j,a_1} = 1$ã€‚

2. å¿½ç•¥æ ·ä¾‹(ignore)ï¼š$\forall k\in \{2,\cdots,|A_S|\}$ï¼Œè‹¥æœ‰ $\text{IOU}_{b_k}^{b_t} > \alpha_{ignore}$ï¼Œä»¤ç½®ä¿¡åº¦ $c_{i,j,a_k}=-1$ã€‚

3. è´Ÿä¾‹(negative)ï¼šæ—¢ä¸æ˜¯positiveä¹Ÿä¸æ˜¯ignoreçš„é”šæ¡† $a_i$ï¼ŒåŠ $\forall i\in \{2,\cdots,|A_S|\}$ï¼Œè‹¥æœ‰ $\text{IOU}_{b_i}^{b_t} \leqslant \alpha_{ignore}$ï¼Œä»¤ç½®ä¿¡åº¦ $c_{i,j,a_k}=0$ã€‚

$$
y_S(i,j,a_k)=
\begin{cases}
(1,x,y,w,h,cls),&\quad k=1,\\
(-1,x,y,w,h,cls),&\quad \text{IOU}_{b_k}^{b_t} > \alpha_{ignore},\\
(0,x,y,w,h,cls),&\quad \text{IOU}_{b_k}^{b_t} \leqslant \alpha_{ignore}.
\end{cases}
$$

åœ¨æŸå¤±ä¸­æ­£ä¾‹åªå¯¹å¸¦æœ‰ $\mathbb{1}^{obj}$ çš„é¡¹äº§ç”ŸæŸå¤±ï¼Œè´Ÿä¾‹åªå¯¹ $\mathbb{1}^{noobj}$ é¡¹äº§ç”ŸæŸå¤±ï¼Œè€Œå¿½ç•¥æ ·ä¾‹åˆ™ä¸äº§ç”ŸæŸå¤±ã€‚æŸå¤±çš„å…·ä½“å½¢å¼è¯·è§ä¸‹ä¸€éƒ¨åˆ†ã€‚

> æ³¨æ„ï¼šä¸Šè¿°çš„ç›®æ ‡æ ‡ç­¾è®¾ç½®æ˜¯åŸºäºâ€œæ²¡æœ‰2ä¸ªåŠä»¥ä¸Šçš„ç›®æ ‡æ¡†çš„ä¸­å¿ƒç‚¹å¤„äºåŒä¸€ç½‘æ ¼å†…â€ï¼Œå¦‚æœåœ¨æ•°æ®é›†ä¸­å‡ºç°è¯¥æƒ…å†µï¼Œåˆ™ä¿ç•™å…¶ä¸­ä»»æ„ä¸€ä¸ªã€‚

ç›®æ ‡çŠ¶æ€çš„ç©ºé—´ç»´åº¦ï¼šå¯¹äºè¾“å…¥å›¾åƒå¤§å°ä¸º $416\times 416\times 3$ ä¸ºä¾‹ï¼Œè¾“å‡ºçš„ $S\in\{13,26,52\}$ï¼Œåˆ™æ¯ä¸ªåˆ’åˆ†å¤§å° $S$ ä¸‹å¯¹åº”çš„ $y_S\in\R^{S\times S\times |A_S|\times 6}$ï¼Œåœ¨æ„å»ºæ•°æ®é›†ä¸­æœ€å¥½è¦æ±‚æ ‡ç­¾ä¿æŒçŸ©é˜µå½¢å¼ï¼Œä½†æ˜¯ç”±äº $S$ çš„å¤§å°ä¸ä¸€ï¼Œæ‰€ä»¥è€ƒè™‘å°†å‰é¢çš„ç»´åº¦æ‹‰ä¼¸ä¸º $\R^{(\sum_{S}S\times S\times |A_S|)\times 6}$ å°±å¯ä»¥ç”¨çŸ©é˜µè¿›è¡Œä¿å­˜äº†ï¼Œä½¿ç”¨æ—¶é‡æ–°è¿›è¡Œåˆ’åˆ†å³å¯ã€‚

### æŸå¤±å‡½æ•°

è®¾ç½‘æ ¼åˆ’åˆ†ä¸º $S$ï¼Œè¯¥åˆ’åˆ†ä¸‹å¯¹åº”å›¾åƒ $x\in(0,1)^{416\times 416\times 3}$ çš„æ ‡ç­¾ä¸º $y_S\in\R^{S\times S\times |A_S|\times 6},\ (S\in\{13,26,52\})$ï¼Œè®¾æ¨¡å‹çš„è¾“å‡ºä¸ºï¼ˆè¿™é‡Œçš„ $\hat{c},\hat{x},\hat{y},\hat{w},\hat{h},\{p_c\}_{c=1}^C$ éƒ½å·²ç»è¿‡[æ¨¡å‹é¢„æµ‹](./#æ¨¡å‹é¢„æµ‹)ä¸­æåˆ°çš„trickså¤„ç†ï¼‰
$$
(S,S,|A_S|,5+C)=\bigg\{(\hat{c},\hat{x},\hat{y},\hat{w},\hat{h},\{p_c\}_{c=1}^C)_{ijk}:(i,j,k)\in\{1,\cdots,S\}^2\times \{1,\cdots,|A_S|\}\bigg\}
$$
åˆ™æŸå¤±å‡½æ•°ä¸ºï¼š

$$
\begin{aligned}
    \mathcal{L} = &\ \sum_{i,j=1}^S\sum_{k=1}^A\mathbb{1}_{ij}^{noobj}\lambda_{noobj}(-\log(1+\text{e}^{\hat{c}_{ijk}}))\\
    &\ +\mathbb{1}_{ijk}^{obj}\Biggl[\lambda_{coord}\sum_{r\in\{x,y\}}\bigg(-r\log(1+\text{e}^{-\hat{r}})-(1-r)\log(1+\text{e}^{\hat{r}})\bigg)\\
    &\ \qquad\qquad+\lambda_{coord}\sum_{r\in\{w,h\}}\bigg(r^{a}_{ijk}\hat{r}-r\bigg)^2\\
    &\ \qquad\qquad+\lambda_{obj}\bigg(-\text{IOU}_k^{true}(1+\text{e}^{-\hat{c}_{ijk}})-(1-\text{IOU}_k^{ture})(1+\text{e}^{\hat{c}_{ijk}})\bigg)\\
    &\ \qquad\qquad+\lambda_{class}\bigg(-\log(\text{softmax}(\{p_c\})_{c_{ij}})\bigg)\Biggl]
\end{aligned}
$$

è¿™é‡Œç¬¬1,2,4é¡¹åˆ†åˆ«æ˜¯å¯¹ $c^{noobj},(x,y)^{obj},c^{obj}$ æŸå¤±çš„è®¡ç®—ï¼Œç”±äºé¢„æµ‹ç»“æœéƒ½åœ¨ $(0,1)$ ä¸­é—´ï¼Œæ‰€ä»¥ä½¿ç”¨çš„æ˜¯BCE(Binary Cross-Entropy)æŸå¤±ï¼›ç¬¬3é¡¹æ˜¯å¯¹ $(w,h)^{obj}$ æŸå¤±çš„è®¡ç®—ï¼Œç»“æœåœ¨ $(0,\infty)$ ä¸­é—´ï¼Œæ‰€ä»¥ç”¨MSEæŸå¤±ï¼›æœ€åä¸€é¡¹æ˜¯å¯¹ $cls^{obj}$ æŸå¤±çš„è®¡ç®—ï¼Œæ˜¯ä¸€ä¸ªåˆ†å¸ƒï¼Œæ‰€ä»¥ç”¨CE(Cross-Entropy)æŸå¤±ã€‚

å…¶ä¸­ $r^a_{ijk}$ è¡¨ç¤ºåœ¨ç½‘æ ¼ $(i,j)$ å¤„çš„ç¬¬ $k$ ä¸ªé”šæ¡†å¯¹åº”çš„å®½($r=w$)é«˜($r=h$)ï¼Œ$\lambda_{noobj},\lambda_{coord},\lambda_{obj},\lambda_{class}$ å‡ä¸ºè¶…å‚æ•°ï¼Œæˆ‘å–å¾—åˆ†åˆ«ä¸º $2,2,1,1$ï¼ˆè®ºæ–‡ä¸­æ²¡æœ‰æåˆ°ï¼‰ã€‚

### è®­ç»ƒç»“æœ

æˆ‘åœ¨è®­ç»ƒä¸­ä½¿ç”¨äº†åœ¨ImageNetä¸Šè®­ç»ƒçš„æŠ€å·§ï¼Œä¸»è¦æ˜¯Learning rate warming upå’Œcosine annealï¼Œçœ‹å­¦ä¹ ç‡æ›²çº¿å°±èƒ½ä¸€çœ¼çœ‹æ‡‚ã€‚æœ‰æ„æ€çš„æ˜¯ï¼Œå½“æˆ‘å†»ç»“DarkNetéƒ¨åˆ†æ—¶ï¼Œè®­ç»ƒç»“æœæå·®ï¼Œåªæœ‰å¯¹å…¨éƒ¨å‚æ•°è¿›è¡Œè®­ç»ƒæ—¶ï¼Œæ‰å¾—åˆ°æ¯”è¾ƒå¥½çš„ç»“æœï¼ˆä¼°è®¡è¿˜æ˜¯å…ˆå†»ç»“åœ¨è§£å†»è®­ç»ƒæ•ˆæœæ‰å¥½äº›å§ï¼‰ã€‚

æˆ‘åˆ†åˆ«åœ¨PASCAL VOCå’ŒCOCOæ•°æ®é›†ä¸Šè¿›è¡Œäº†æµ‹è¯•ï¼Œéƒ½è®­ç»ƒäº†80ä¸ªepochsï¼ŒPASCALè®­ç»ƒå›¾åƒ[wandb-reports](https://api.wandb.ai/links/wty-yy/j4wyvk1l)ï¼ŒCOCOè®­ç»ƒå›¾åƒ[wandb-reports](https://api.wandb.ai/links/wty-yy/qr7z9ws3)

ç”±äºæ²¡æœ‰è¿›è¡Œæ•°æ®å¢å¼ºï¼Œåœ¨PASCALä¸Šçš„mAP@50åªæœ‰64.9%ä½äº†10%ï¼Œæ‰“ç®—åç»­åŠ å…¥æ•°æ®å¢å¼ºåå†è¿›è¡Œä¸€æ¬¡æµ‹è¯•ï¼Œæ¨¡å‹æƒé‡ä¹Ÿå°±å…ˆä¸ä¸Šä¼ äº†ã€‚

æœ€åæ˜¯è§†é¢‘è¯†åˆ«æ•ˆæœï¼Œæ¨¡å‹çš„è¯†åˆ«é€Ÿåº¦447fpsï¼Œå‰ªè¾‘é€Ÿåº¦ä¸º92fpsï¼ˆè¢«è§†é¢‘è¯»å–é€Ÿåº¦æ‰€é™åˆ¶ï¼‰ï¼Œä¸Šä¼ äº†4ä¸ªè§†é¢‘åˆ°[Google Drive](https://drive.google.com/drive/folders/1rsw9iF7RQVqn90hbrNgquTGocb2kvGst?usp=drive_link)ï¼Œä»£ç ï¼š[GitHub - KataCV/yolov3/process_mp4.py](https://github.com/wty-yy/KataCV/blob/master/katacv/yolov3/process_mp4.py)å’Œ[ç™¾åº¦ç½‘ç›˜](https://pan.baidu.com/s/1V4_ykvG462FvQo8Hm-Rgow)ï¼ˆæå–ç : 1234ï¼‰ï¼Œéƒ½å¯ä»¥åœ¨çº¿è§‚çœ‹ã€‚

